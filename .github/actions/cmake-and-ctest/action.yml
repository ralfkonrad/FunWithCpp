name:
  cmake-and-ctest
description:
  Builds the project and tests it using cmake and ctest

inputs:
  os:
    description: The os for the run.
    required: true

  cxx-standard:
    description: The c++ standard used with the run.
    required: true

  compiler:
    description: The compiler to use.
    required: true

  compiler-version:
    description: The compiler version to use.
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Setup needed software
      id: setup
      uses: ./.github/actions/setup
      with:
        os:           ${{ inputs.os }}
        cxx-standard: ${{ inputs.cxx-standard }}

    - name: Get C and CXX compiler
      id: cxx-compiler
      uses: ./.github/actions/get-cxx-compiler
      with:
        compiler:         ${{ matrix.compiler }}
        compiler-version: ${{ matrix.compiler-version }}

    - name: Configure CMake and Build
      env:
        ccache:       ${{ steps.setup.outputs.ccache-variant }}
        c-compiler:   ${{ steps.cxx-compiler.outputs.c-compiler }}
        cxx-compiler: ${{ steps.cxx-compiler.outputs.cxx-compiler }}
      shell: bash
      working-directory:
      run: |
        cmake --version
        cmake -S . -B ./build -DCMAKE_C_COMPILER=${{ c-compiler }} -DCMAKE_CXX_COMPILER=${{ cxx-compiler }} -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_COMPILER_LAUNCHER=$ccache
        cmake --build ./build

    - name: Test
      env:
        preset: ${{ steps.determine-preset.outputs.preset }}
      working-directory: ./build
      shell: bash
      run: |
        ctest -C Release
