name: cmake-and-ctest
description: Builds the project and tests it using cmake and ctest

inputs:
  os:
    description: The os for the run.
    required: true

  cxx-standard:
    description: The c++ standard used with the run.
    required: true

  compiler:
    description: The compiler to use.
    required: true

  ccache-variant:
    description: The ccache variant to use with the ccache-action
    required: true

runs:
  using: composite
  steps:
    - id: determine-preset
      shell: bash
      run: |
        echo "preset=${{ ( (inputs.runner-os == 'Windows') && 'windows-mscv' ) || ( inputs.os + '-' + inputs.compiler ) }}-release-ninja" >> $GITHUB_OUTPUT
        more $GITHUB_OUTPUT

    - name: Configure CMake and Build
      env:
        preset: ${{ steps.determine-preset.outputs.preset }}
      shell: bash
      run: |
        cmake --version
        cmake --preset $preset -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} -DCMAKE_CXX_COMPILER_LAUNCHER=${{ inputs.ccache-variant }}
        cmake --build --preset $preset -v

    - name: Test
      env:
        preset: ${{ steps.determine-preset.outputs.preset }}
      shell: bash
      run: |
        ctest --preset $preset
