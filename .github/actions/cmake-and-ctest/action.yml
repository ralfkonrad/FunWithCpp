name:
  cmake-and-ctest
description:
  Builds the project and tests it using cmake and ctest

inputs:
  os:
    description: The os for the run.
    required: true

  cxx-standard:
    description: The c++ standard used with the run.
    required: true

  compiler:
    description: The compiler to use.
    required: true

  compiler-version:
    description: The compiler version to use.
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Get C and CXX compiler
      id: cxx-compiler
      uses: ./.github/actions/get-cxx-compiler
      with:
        compiler:         ${{ matrix.compiler }}
        compiler-version: ${{ matrix.compiler-version }}

    - name: Setup needed software
      id: setup
      uses: ./.github/actions/setup
      with:
        os:           ${{ inputs.os }}
        cxx-standard: ${{ inputs.cxx-standard }}

    - name: Configure CMake and Build
      env:
        CC:                           ${{ steps.cxx-compiler.outputs.c-compiler }}
        CXX:                          ${{ steps.cxx-compiler.outputs.cxx-compiler }}
        CMAKE_CONFIG_TYPE:            Release
        CMAKE_GENERATOR:              Ninja
        CMAKE_CXX_COMPILER_LAUNCHER:  ${{ steps.setup.outputs.ccache-variant }}
      shell: bash
      run: |
        cmake --version
        cmake -S . -B ./build -DRKE_COMPILE_WARNING_AS_ERROR=ON -DCMAKE_CXX_STANDARD=${{ inputs.cxx-standard }} -LA
        cmake --build ./build -v

    - name: Test
      env:
        CMAKE_CONFIG_TYPE:            Release
      working-directory: ./build
      shell: bash
      run: |
        ctest --extra-verbose
